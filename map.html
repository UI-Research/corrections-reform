<!DOCTYPE html>
<meta charset="utf-8">
<script src="lib/d3.v3.min.js"></script>
<script src="lib/d3-queue.v3.min.js"></script>
<script src="lib/topojson.min.js"></script>
<style>
    .districts {
        stroke: #ffffff;
        stroke-width: 1px;
        pointer-events: cursor;
    }
    
    .districts.hovered {
        stroke: #000000;
    }
    
    .district.hovered {
        stroke: #fdbf11;
        stroke-width: 2px;
    }
    
    .sentence-arcs {
        display: none;
        fill: none;
        stroke: #ec008b;
        stroke-width: 1px;
        pointer-events: none;
    }
    
    .sentence-arcs.hovered {
        display: inline;
    }
    
    .centroids circle {
        fill: #d69fd2;
        stroke: #000;
        pointer-events: none;
    }
    
    .complexes circle {
        fill: #ffffff;
        stroke: #000;
        pointer-events: none;
    }
</style>

<body>

    <script>
        d3.selection.prototype.moveToFront = function () {
            return this.each(function () {
                this.parentNode.appendChild(this);
            });
        };

        var blue5 = ["#b0d5f1", "#82c4e9", "#1696d2", "#00578b", "#00152A"];
        var BREAKS = [1000, 1500, 2000, 3000];

        var width = 1000,
            height = 600;

        var projection = d3.geo.albersUsa()
            .translate([width / 2, height / 2])
            .scale(width * 1.2);

        var color = d3.scale.linear()
            .domain(BREAKS)
            .range(blue5);

        var path = d3.geo.path()
            .projection(projection);

        var voronoi = d3.geom.voronoi()
            .x(function (d) {
                return d.x;
            })
            .y(function (d) {
                return d.y;
            })
            .clipExtent([[0, 0], [width, height]]);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        d3.json("data/judicialdistricts.json", function (districts) {
            d3.csv("data/districtsentences.csv", function (dt) {
                d3.csv("data/complexzips.csv", function (complexes) {
                    d3.csv("data/zipsbydistrict.csv", function (zbd) {

                        //no Virgin Islands, Guam, Puerto Rico districts or prisons
                        dt = dt.filter(function (d) {
                            return d.districtcode != "VI" & d.districtcode != "GU" & d.districtcode != "PR";
                        });

                        complexes = complexes.filter(function (d) {
                            return d.zip != "00965";
                        });

                        zbd = zbd.filter(function (d) {
                            return d.districtcode != "VI" & d.districtcode != "GU" & d.districtcode != "PR" & d.zip != "00965" & d.zip != "";
                        });

                        //make an array for the district centroid coordinates and zip complex coordinates
                        zbd.forEach(function (d) {
                            d.sentences = +d.sentences;
                            var position = projection(d);
                            d.complex = projection([+d.zip_long, +d.zip_lat]);
                            d.district = projection([+d.centroid_long, +d.centroid_lat]);
                        })

                        //nest by district
                        var zdt = d3.nest()
                            .key(function (d) {
                                return d.districtcode;
                            })
                            .sortKeys(d3.ascending)
                            .entries(zbd);

                        dt.forEach(function (d) {
                            d.sentences = +d.sentences;
                            d[0] = +d.longitude;
                            d[1] = +d.latitude;
                            var position = projection(d);
                            d.centroidx = position[0];
                            d.centroidy = position[1];
                            d.lines = zdt.filter(function (district) {
                                return district.key == d.districtcode;
                            })[0];
                        })

                                                console.log(dt);
                        
                        complexes.forEach(function (d) {
                            d.sentences = +d.sentences;
                            d[0] = +d.longitude;
                            d[1] = +d.latitude;
                            var position = projection(d);
                            d.complexx = position[0];
                            d.complexy = position[1];
                        });

                        //judicial districts boundaries
                        svg.append("g")
                            .attr("class", "districts")
                            .selectAll("path")
                            .data(topojson.feature(districts, districts.objects.JudicialDistricts_Final).features)
                            .enter().append("path")
                            .attr("d", path)
                            .attr("class", "district")
                            .attr("code", function (d) {
                                return d.properties.code;
                            })
                            .attr("fill", function (d) {
                                return color(d.properties.sentences);
                            })
                            .on("mouseover", function (d) {
                            if (d.properties.code != "AK") {
                                d3.selectAll(".hovered")
                                    .classed("hovered", false);
                                d3.selectAll("." + d3.select(this).attr("code"))
                                    .classed("hovered", true);
                                d3.select(this).classed("hovered", true);
                                d3.select(this).moveToFront();
                            } else {
                                //Alaska is being a special browser crashing snowflake with this.classed
                                d3.select(this).attr("stroke", "#fdbf11")
                                d3.selectAll(".AK")
                                    .classed("hovered", true);
                            }
                            })
                            .on("mouseout", function (d) {
                                d3.select(this).attr("stroke", "#ffffff")
                                d3.selectAll(".hovered")
                                    .classed("hovered", false);
                            })

                        //prison complexes
                        var complex = svg.append("g")
                            .attr("class", "complexes")
                            .selectAll("g")
                            .data(complexes.sort(function (a, b) {
                                return b.sentences - a.sentences;
                            }))
                            .enter().append("g")
                            .attr("class", "complex");

                        complex.append("circle")
                            .attr("cx", function (d) {
                                return d.complexx;
                            })
                            .attr("cy", function (d) {
                                return d.complexy;
                            })
                            .attr("r", function (d, i) {
                                return Math.sqrt(d.sentences) / 10;
                            });

                        //district centroids - don't draw, but that's where the lines emanate from
                        var centroid = svg.append("g")
                            .attr("class", "centroids")
                            .selectAll("g")
                            .data(dt)
                            .enter().append("g")
                            .attr("class", function (d) {
                                return d.districtcode + " centroid";
                            })
                            .attr("temp", function (d) {
                                return d.lines.key;
                            })

                        centroid.append("g")
                            .attr("class", function (d) {
                                return d.districtcode + " sentence-arcs";
                            })
                            .selectAll("path")
                            .data(function (d) {
                                return d.lines.values;
                            })
                            .enter().append("line")
                            .attr("zip", function (d) {
                                return d.zip;
                            })
                            .attr("x1", function (d) {
                                return d.district[0];
                            })
                            .attr("y1", function (d) {
                                return d.district[1];
                            })
                            .attr("x2", function (d) {
                                return d.complex[0];
                            })
                            .attr("y2", function (d) {
                                return d.complex[1];
                            })

                    });

                });

            });
        });
    </script>